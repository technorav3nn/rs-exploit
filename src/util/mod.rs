use std::{
    collections::HashMap,
    process::{Command, Stdio},
};

#[macro_export]
macro_rules! hashmap {
    ($( $key: expr => $val: expr ),*) => {{
        let mut map = ::std::collections::HashMap::new();
        $( map.insert($key.to_string(), $val.to_string()); )*
        map
    }}
}

pub fn get_processes() -> Result<(), Box<dyn std::error::Error>> {
    let output = Command::new("ps")
        .arg("-exo")
        .arg("pid,args")
        .stdout(Stdio::piped())
        .spawn()?
        .wait_with_output()?;

    let stdout = String::from_utf8_lossy(&output.stdout).to_string();
    let processes: Vec<&str> = stdout
        .split("\n")
        .filter(|e| {
            e.contains("RobloxPlayer")
                && !e.contains("--crashHandler")
                && (e.contains("-ticket") || e.ends_with("RobloxPlayer"))
        })
        .collect();

    let mut results: Vec<HashMap<String, String>> = Vec::new();
    for process in processes {
        let split: Vec<&str> = process.split(" ").collect();
        let mut index: usize = 0;
        while let Some(c) = split[index..].first() {
            if let Ok(pid) = c.parse::<u32>() {
                let command = split[index + 1];
                let arguments = split[index + 2..].join(" ");
                let map = hashmap! {
                    "pid".to_string() => pid.to_string(),
                    "command".to_string() => command.to_string(),
                    "arguments".to_string() => arguments.to_string()
                };
                results.push(map);
                break;
            }
            index += 1;
        }
    }
    println!("{:?}", results);
    Ok(())
}

pub fn is_roblox_process(pid: i32) -> bool {
    let output = Command::new("ps")
        .arg("-o")
        .arg("command")
        .arg("-p")
        .arg(pid.to_string())
        .output()
        .expect("Failed to execute ps command");

    let command_output = String::from_utf8(output.stdout).unwrap();

    let is_roblox = command_output.find("RobloxPlayer").is_some()
        && !command_output.find("CrashpadHandlerExe").is_some();

    is_roblox
}
